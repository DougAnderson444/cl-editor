<div class="cl">
  <div class="cl-actionbar">
    {{#each actionBtns as action}}
      <button 
        class="cl-button {{action.active ? 'active' : ''}} {{action.dropdown ? 'dropdown' : ''}}" 
        title="{{action.title}}" 
        on:click="_btnClicked(action)" 
        disabled="{{action.disabled}}">
        {{{action.icon}}}
      </button>
    {{/each}}
  </div>
  <div ref:editor 
    class="cl-content"
    style="height: {{height}}"
    contenteditable="true"
    on:input="_onChange(event.target.innerHTML)" 
    on:mouseup="_handleButtonStatus()" 
    on:keyup="_handleButtonStatus()"
    on:paste="_onPaste(event)"
    on:blur="_onBlur(event)">
  </div>
  
  <textarea ref:raw class="cl-textarea" style="height: {{height}}"></textarea>
  <div ref:modal></div>
  <div ref:dropdown></div>
</div>

<script>
  import {
    getTagsRecursive,
    saveRange,
    restoreRange,
    exec,
    cleanHtml,
    getActionBtns,
    getNewActionObj
  } from './helpers/util';
  import actions from './helpers/actions';
  import EditorModal from './helpers/EditorModal.html';
  import EditorDropdown from './helpers/EditorDropdown.html';
  let modal;
  let dropdown;

  export default {
    data() {
      return {
        actionBtns: [],
        height: '300px',
        html: ''
      }
    },
    oncreate() {
      const data = this.options.data || {};
      const actionObj = getNewActionObj(actions, data.actions);
      this.set({ actionBtns: getActionBtns(actionObj), actionObj });
      this.setHtml(data.html);
      modal = new EditorModal({ target: this.refs.modal });
      dropdown = new EditorDropdown({ target: this.refs.dropdown });
    },
    methods: {
      _btnClicked: function(action) {
        saveRange(this.refs.editor);
        restoreRange(this.refs.editor);
        action.result.apply(this, [modal, dropdown]);
        this._handleButtonStatus();
      },
      _handleButtonStatus: function() {
        const tags = getTagsRecursive(document.getSelection().focusNode);
        const actionObj = this.get('actionObj');
        Object.keys(actionObj).forEach((action) => actionObj[action].active = false);
        tags.forEach((tag) => (actionObj[tag.toLowerCase()] || {}).active = true);
        this.set({ actionBtns: getActionBtns(actionObj), actionObj });
      },
      _onPaste: function(event) {
        event.preventDefault();
        exec('insertHTML', cleanHtml(event.clipboardData.getData('text/html')));
      },
      _onChange: function(html) {
        this.fire('change', html);
      },
      _onBlur: function(event) {
        this.fire('blur', event);
      },
      exec: (cmd, value) => {
        exec(cmd, value)
      },
      getHtml: function() {
        return this.refs.editor.innerHTML;
      },
      getText: function() {
        return refs.editor.innerText;
      },
      setHtml: function(html) {
        this.refs.editor.innerHTML = html || '';
      }
    }
  }
</script>

<style type="text/css">
  .cl * {
    box-sizing: border-box;
  }

  .cl {
    box-shadow: 0 2px 3px rgba(10, 10, 10, 0.1), 0 0 0 1px rgba(10, 10, 10, 0.1);
    box-sizing: border-box;
    width: 100%;
    position: relative;
  }

  .cl-content {
    box-sizing: border-box;
    height: 300px;
    outline: 0;
    overflow-y: auto;
    padding: 10px;
    width: 100%;
  }

  .cl-actionbar {
    background-color: #ecf0f1;
    border-bottom: 1px solid rgba(10, 10, 10, 0.1);
    width: 100%;
  }

  .cl-button {
    background-color: transparent;
    border: none;
    cursor: pointer;
    height: 35px;
    outline: 0;
    width: 35px;
    vertical-align: top;
    position: relative;
  }

  .cl-button:hover, .cl-button.active {
    background-color: #fff;
  }

  .cl-button:disabled {
    opacity: .5;
    pointer-events: none;
  }

  .cl-button.dropdown::after {
    display: block;
    content: " ";
    position: absolute;
    top: 25px;
    right: 3px;
    height: 0;
    width: 0;
    border: 3px solid rgba(0, 0, 0, 0);
    border-top-color: #555;
  }

  .cl-textarea {
    display: none;
    width: 100%;
    max-width: 100%;
    border: none;
    padding: 10px;
    box-sizing: border-box;
  }

  .cl-textarea:focus {
    outline: none;
  }

</style>
